pipeline {
    agent any
    
    tools {
        nodejs 'node_23'
    }
    
    environment {
        POSTGRES_USER = 'postgres'
        POSTGRES_PASSWORD = 'postgres'
        POSTGRES_DB = 'zelda_cookbook'
        POSTGRES_HOST = 'localhost'
        POSTGRES_PORT = '5432'
    }
    
    stages {
        stage('Clone Repository') {
            steps {
                sshagent(['github']) {
                    sh 'rm -rf backend'
                    sh 'git clone git@github.com:le7-devops/backend.git'
                }
            }
        }
        
        stage('Check PostgreSQL Service') {
            steps {
                script {
                    // בדוק אם PostgreSQL פעיל ופועל
                    sh '''
                        echo "בודק אם שירות PostgreSQL כבר פעיל..."
                        if netstat -tuln | grep ${POSTGRES_PORT}; then
                            echo "PostgreSQL פעיל ב-port ${POSTGRES_PORT}"
                        else
                            echo "אזהרה: לא נמצא שירות PostgreSQL פעיל ב-port ${POSTGRES_PORT}!"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Verify Database Connection') {
            steps {
                script {
                    // בדוק את החיבור לבסיס הנתונים
                    sh '''
                        echo "בודק חיבור PostgreSQL..."
                        PGPASSWORD=${POSTGRES_PASSWORD} psql -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -c "SELECT 1 as connection_test;"
                        
                        # בדוק אם בסיס הנתונים קיים
                        if ! PGPASSWORD=${POSTGRES_PASSWORD} psql -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -lqt | cut -d \\| -f 1 | grep -qw ${POSTGRES_DB}; then
                            echo "יוצר בסיס נתונים ${POSTGRES_DB}..."
                            PGPASSWORD=${POSTGRES_PASSWORD} psql -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -c "CREATE DATABASE ${POSTGRES_DB};"
                        else
                            echo "בסיס הנתונים ${POSTGRES_DB} כבר קיים"
                        fi
                    '''
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                dir('backend') {
                    sh 'npm install'
                    
                    // עדכן את מחרוזת החיבור להשתמש בשרת PostgreSQL המקומי
                    sh '''
                        sed -i "s|postgres:postgres@db:5432|${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}|g" knexfile.js
                    '''
                    
                    // הצג את מחרוזת החיבור המעודכנת
                    sh 'grep -n "connection:" knexfile.js || echo "לא נמצאה מחרוזת חיבור"'
                    
                    // עדכן את הגדרת timeout לטסטים
                    sh '''
                        if grep -q "test.*mocha --exit" package.json; then
                            sed -i 's/"test": "NODE_ENV=test mocha --exit"/"test": "NODE_ENV=test mocha --exit --timeout 30000"/g' package.json
                        else
                            echo "לא נמצאה הגדרת test מתאימה ב-package.json"
                        fi
                    '''
                }
            }
        }
        
        stage('Run Unit Tests') {
            steps {
                dir('backend') {
                    withEnv(['NODE_ENV=test', 'KEY=zelda-test-secret-key']) {
                        // הדפס מידע סביבתי
                        sh '''
                            echo "גרסת Node: $(node -v)"
                            echo "תיקייה נוכחית: $(pwd)"
                            echo "הגדרת סביבה: NODE_ENV=${NODE_ENV}"
                        '''
                        
                        // הרץ את הבדיקות עם timeout מוגדל
                        sh 'NODE_ENV=test mocha --exit --timeout 30000'
                    }
                }
            }
            post {
                success {
                    echo 'כל הבדיקות עברו בהצלחה!'
                }
                failure {
                    echo 'הבדיקות נכשלו! בדוק את הלוגים לפרטים נוספים.'
                    
                    // הצג מידע דיאגנוסטי נוסף בכישלון
                    sh '''
                        echo "בדיקת חיבור לבסיס הנתונים:"
                        PGPASSWORD=${POSTGRES_PASSWORD} psql -h ${POSTGRES_HOST} -p ${POSTGRES_PORT} -U ${POSTGRES_USER} -c "\\l" || echo "לא ניתן להתחבר לבסיס הנתונים"
                    '''
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    sh 'docker build -f ./Dockerfile -t zelda_backend .'
                }
            }
        }
        
        stage('Login to GHCR and Push Docker Image') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'ghcr-token', variable: 'GITHUB_TOKEN')]) {
                        sh 'echo $GITHUB_TOKEN | docker login ghcr.io -u le7-devops --password-stdin'
                        sh 'docker tag zelda_backend ghcr.io/le7-devops/backend:latest'
                        sh 'docker push ghcr.io/le7-devops/backend:latest'
                    }
                }
            }
        }
        
        stage('Push Version to Git') {
            steps {
                sshagent(['github']) {
                    script {
                        sh 'git config user.email "sara.beck.dev@example.com"'
                        sh 'git config user.name "Sara"'
                        sh 'git tag -a v$(date +"%Y%m%d%H%M%S") -m "Automated version update"'
                        sh 'git push --tags'
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'הפייפליין הושלם'
        }
    }
}